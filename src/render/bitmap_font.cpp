#include "render/bitmap_font.hpp"

#include <algorithm>
#include <cctype>

namespace eclipse {

BitmapFont& BitmapFont::instance() {
    static BitmapFont font;
    return font;
}

BitmapFont::BitmapFont() {
    auto addGlyph = [this](char c, std::initializer_list<uint8_t> rows, int width) {
        Glyph glyph;
        glyph.width = width;
        glyph.rows.assign(rows.begin(), rows.end());
        glyphs_.emplace(c, std::move(glyph));
    };

    // Uppercase characters (5x7 patterns)
    addGlyph('A', {0x0E, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11}, 5);
    addGlyph('B', {0x1E, 0x11, 0x1E, 0x11, 0x11, 0x11, 0x1E}, 5);
    addGlyph('C', {0x0E, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0E}, 5);
    addGlyph('D', {0x1C, 0x12, 0x11, 0x11, 0x11, 0x12, 0x1C}, 5);
    addGlyph('E', {0x1F, 0x10, 0x1E, 0x10, 0x10, 0x10, 0x1F}, 5);
    addGlyph('F', {0x1F, 0x10, 0x1E, 0x10, 0x10, 0x10, 0x10}, 5);
    addGlyph('G', {0x0E, 0x11, 0x10, 0x17, 0x11, 0x11, 0x0E}, 5);
    addGlyph('H', {0x11, 0x11, 0x1F, 0x11, 0x11, 0x11, 0x11}, 5);
    addGlyph('I', {0x0E, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0E}, 5);
    addGlyph('J', {0x07, 0x02, 0x02, 0x02, 0x12, 0x12, 0x0C}, 5);
    addGlyph('K', {0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11}, 5);
    addGlyph('L', {0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1F}, 5);
    addGlyph('M', {0x11, 0x1B, 0x15, 0x15, 0x11, 0x11, 0x11}, 5);
    addGlyph('N', {0x11, 0x19, 0x15, 0x13, 0x11, 0x11, 0x11}, 5);
    addGlyph('O', {0x0E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E}, 5);
    addGlyph('P', {0x1E, 0x11, 0x11, 0x1E, 0x10, 0x10, 0x10}, 5);
    addGlyph('Q', {0x0E, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0D}, 5);
    addGlyph('R', {0x1E, 0x11, 0x11, 0x1E, 0x14, 0x12, 0x11}, 5);
    addGlyph('S', {0x0F, 0x10, 0x0E, 0x01, 0x01, 0x11, 0x0E}, 5);
    addGlyph('T', {0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04}, 5);
    addGlyph('U', {0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E}, 5);
    addGlyph('V', {0x11, 0x11, 0x11, 0x11, 0x0A, 0x0A, 0x04}, 5);
    addGlyph('W', {0x11, 0x11, 0x11, 0x15, 0x15, 0x1B, 0x11}, 5);
    addGlyph('X', {0x11, 0x11, 0x0A, 0x04, 0x0A, 0x11, 0x11}, 5);
    addGlyph('Y', {0x11, 0x11, 0x0A, 0x04, 0x04, 0x04, 0x04}, 5);
    addGlyph('Z', {0x1F, 0x02, 0x04, 0x08, 0x10, 0x10, 0x1F}, 5);

    // Digits
    addGlyph('0', {0x0E, 0x11, 0x13, 0x15, 0x19, 0x11, 0x0E}, 5);
    addGlyph('1', {0x04, 0x0C, 0x04, 0x04, 0x04, 0x04, 0x0E}, 5);
    addGlyph('2', {0x0E, 0x11, 0x01, 0x06, 0x08, 0x10, 0x1F}, 5);
    addGlyph('3', {0x1F, 0x02, 0x04, 0x02, 0x01, 0x11, 0x0E}, 5);
    addGlyph('4', {0x02, 0x06, 0x0A, 0x12, 0x1F, 0x02, 0x02}, 5);
    addGlyph('5', {0x1F, 0x10, 0x1E, 0x01, 0x01, 0x11, 0x0E}, 5);
    addGlyph('6', {0x06, 0x08, 0x10, 0x1E, 0x11, 0x11, 0x0E}, 5);
    addGlyph('7', {0x1F, 0x01, 0x02, 0x04, 0x04, 0x04, 0x04}, 5);
    addGlyph('8', {0x0E, 0x11, 0x11, 0x0E, 0x11, 0x11, 0x0E}, 5);
    addGlyph('9', {0x0E, 0x11, 0x11, 0x0F, 0x01, 0x02, 0x0C}, 5);

    addGlyph('-', {0x00, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x00}, 5);
    addGlyph(':', {0x00, 0x06, 0x06, 0x00, 0x06, 0x06, 0x00}, 5);
    addGlyph('.', {0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x06}, 5);
    addGlyph(' ', {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, 3);
}

const BitmapFont::Glyph* BitmapFont::glyphFor(char c) const {
    auto it = glyphs_.find(c);
    if (it != glyphs_.end()) {
        return &it->second;
    }
    return nullptr;
}

void BitmapFont::drawText(SDL_Renderer* renderer, const std::string& text,
                          int x, int y, SDL_Color color, int scale) const {
    if (!renderer) {
        return;
    }
    int cursorX = x;
    int cursorY = y;
    SDL_SetRenderDrawColor(renderer, color.r, color.g, color.b, color.a);

    for (char c : text) {
        if (c == '\n') {
            cursorY += lineHeight(scale);
            cursorX = x;
            continue;
        }
        if (std::islower(static_cast<unsigned char>(c))) {
            c = static_cast<char>(std::toupper(static_cast<unsigned char>(c)));
        }
        const Glyph* glyph = glyphFor(c);
        if (!glyph) {
            cursorX += scale * 4;
            continue;
        }
        for (size_t row = 0; row < glyph->rows.size(); ++row) {
            uint8_t bits = glyph->rows[row];
            for (int col = 0; col < glyph->width; ++col) {
                int bitIndex = glyph->width - 1 - col;
                if (bits & (1 << bitIndex)) {
                    SDL_Rect pixel{cursorX + col * scale, cursorY + static_cast<int>(row) * scale, scale, scale};
                    SDL_RenderFillRect(renderer, &pixel);
                }
            }
        }
        cursorX += (glyph->width + 1) * scale;
    }
}

int BitmapFont::measureTextWidth(const std::string& text, int scale) const {
    int width = 0;
    for (char c : text) {
        if (c == '\n') {
            break;
        }
        if (std::islower(static_cast<unsigned char>(c))) {
            c = static_cast<char>(std::toupper(static_cast<unsigned char>(c)));
        }
        const Glyph* glyph = glyphFor(c);
        if (glyph) {
            width += (glyph->width + 1) * scale;
        } else {
            width += 4 * scale;
        }
    }
    return width;
}

int BitmapFont::lineHeight(int scale) const {
    return 8 * scale;
}

}  // namespace eclipse
